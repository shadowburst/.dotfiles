#!/usr/bin/env bash

# A list of either directories or directory:depth pairs to search for projects.
SESSION_DIRS=(~/.dotfiles ~/Repos:1)
SESSION_STATE_HOME="$XDG_STATE_HOME/$USER/tmux"
SESSION_TEMPLATES_HOME="$SESSION_STATE_HOME/templates"
SESSION_STATE_FILE="$SESSION_STATE_HOME/templates.json"

# Parse directories and build find commands
dirs=()
for dir_spec in "${SESSION_DIRS[@]}"; do
  path="${dir_spec%:*}"
  depth="${dir_spec#*:}"
  # If no depth specified, default to 0 (just the folder itself)
  [[ "$depth" == "$dir_spec" ]] && depth=0

  if [[ $depth -eq 0 ]]; then
    # Depth 0: just the exact directory itself
    if [[ -d "$path" ]]; then
      dirs+=("$path")
    fi
  else
    # Depth > 0: find subdirectories up to specified depth
    while IFS= read -r result; do
      dirs+=("$result")
    done < <(find "$path" -maxdepth "$depth" -mindepth 1 -type d 2>/dev/null)
  fi
done

session_path=$(
  printf '%s\n' "${dirs[@]}" |
    fzf \
      --preview="tree -a -L 1 -C --dirsfirst --sort=name --noreport {}"
)

if [[ -z $session_path ]]; then
  exit 0
fi

session=$(basename "$session_path" | tr . _)
editor=${EDITOR:-nvim}

if ! tmux has-session -t="$session" 2>/dev/null; then
  tmux new-session -ds "$session" -c "$session_path" -n "$editor" "$editor; ${SHELL:-bash}"

  if [[ ! -f "$SESSION_STATE_FILE" ]]; then
    mkdir -p "$SESSION_STATE_HOME"
    echo "{}" >"$SESSION_STATE_FILE"
  fi
  if jq -e ".[\"${session}\"]" "$SESSION_STATE_FILE" >/dev/null; then
    template=$(jq -r ".[\"${session}\"]" "$SESSION_STATE_FILE")
  else
    template=$(
      echo -e "No template\n$(find -L "$SESSION_TEMPLATES_HOME" -type f -executable -printf "%f\n")" | fzf
    )
    jq ". + { \"${session}\": \"${template}\" }" "$SESSION_STATE_FILE" >"$SESSION_STATE_FILE.tmp"
    mv "$SESSION_STATE_FILE.tmp" "$SESSION_STATE_FILE"
  fi

  template_script="$SESSION_TEMPLATES_HOME/$template"
  if [[ -f $template_script ]]; then
    $template_script "$session" "$session_path"
  fi
fi

if [[ -n $TMUX ]]; then
  tmux switch-client -t "$session"
else
  tmux attach -t "$session"
fi
